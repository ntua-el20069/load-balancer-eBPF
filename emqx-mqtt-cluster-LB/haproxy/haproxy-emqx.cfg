defaults
  mode tcp
  timeout client 60s
  timeout connect 5s
  timeout server 60s

# MQTT Frontend
frontend mqtt_frontend
  bind *:1883
  default_backend emqx_brokers

# MQTT WebSocket Frontend  
frontend mqtt_ws_frontend
  bind *:8083
  default_backend emqx_ws_brokers

# EMQX Dashboard Frontend
frontend dashboard_frontend
  bind *:18083
  default_backend emqx_dashboard

# MQTT Backend (TCP)
backend emqx_brokers
  mode tcp
  balance roundrobin  # Important: Use source-based balancing for MQTT
  option tcp-check
  server emqx1 emqx1:1883 check
  server emqx2 emqx2:1883 check

# MQTT WebSocket Backend
backend emqx_ws_brokers
  mode tcp
  balance roundrobin
  option tcp-check
  server emqx1 emqx1:8083 check
  server emqx2 emqx2:8083 check

# Dashboard Backend
backend emqx_dashboard
  mode tcp
  balance roundrobin
  option tcp-check
  server emqx1 emqx1:18083 check
  server emqx2 emqx2:18083 check

# Stats endpoint
listen stats
  bind *:8404
  stats enable
  stats uri /
  stats refresh 5s
